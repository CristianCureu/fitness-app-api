generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  CLIENT
  TRAINER
}

enum ClientStatus {
  ACTIVE
  PAUSED
  COMPLETED
}

enum SessionStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum ExerciseCategory {
  SQUAT
  LUNGE
  HINGE
  HORIZONTAL_PUSH
  HORIZONTAL_PULL
  VERTICAL_PUSH
  VERTICAL_PULL
  GLUTES_HAMSTRINGS
  CORE
  FULL_BODY_POWER
  CARDIO_CONDITIONING
  OTHER
}

enum ExerciseDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

// ============================================
// MODELS
// ============================================

model AppUser {
  id     String   @id @default(uuid()) @db.Uuid
  authId String   @unique @db.Uuid // Supabase auth.users.id
  role   UserRole

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clientProfile     ClientProfile?
  trainerProfile    TrainerProfile?
  trainerClients    ClientProfile[]    @relation("TrainerClients")
  scheduledSessions ScheduledSession[] @relation("TrainerSessions")
  createdInvites    InviteCode[]       @relation("TrainerInvites")
  usedInvite        InviteCode?        @relation("UsedInvite")
  createdPrograms   WorkoutProgram[]   @relation("TrainerPrograms")
  createdExercises  Exercise[]         @relation("TrainerExercises")

  @@map("app_users")
}

model ClientProfile {
  id     String  @id @default(uuid()) @db.Uuid
  userId String  @unique @db.Uuid // 1-to-1 with AppUser
  user   AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  trainerId String  @db.Uuid
  trainer   AppUser @relation("TrainerClients", fields: [trainerId], references: [id])

  firstName String
  lastName  String
  timezone  String @default("UTC") // IANA timezone (e.g., "America/New_York")

  // Physical attributes
  age    Int?
  height Float? // in cm
  weight Float? // in kg

  goalDescription            String? // "-8kg in 3 months"
  status                     ClientStatus @default(ACTIVE)
  programStartDate           DateTime?
  programWeeks               Int?
  recommendedSessionsPerWeek Int?

  // Onboarding tracking
  onboardingCompleted   Boolean   @default(false)
  onboardingCompletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  scheduledSessions    ScheduledSession[]
  dailyRecommendations DailyRecommendation[]
  checkins             DailyCheckin[]
  nutritionGoals       NutritionGoal[]
  activeProgram        ClientProgram?
  recommendationLogs   ProgramRecommendationLog[]

  @@index([trainerId])
  @@map("client_profiles")
}

model TrainerProfile {
  id     String  @id @default(uuid()) @db.Uuid
  userId String  @unique @db.Uuid // 1-to-1 with AppUser
  user   AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName String
  lastName  String
  bio       String? // Optional bio/description

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("trainer_profiles")
}

model ScheduledSession {
  id String @id @default(uuid()) @db.Uuid

  clientId String        @db.Uuid
  client   ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  trainerId String  @db.Uuid
  trainer   AppUser @relation("TrainerSessions", fields: [trainerId], references: [id])

  sessionName String // ex: "Upper Body A"
  sessionType String? // ex: "UPPER", "FULL_BODY" etc. (can become enum later)

  startAt DateTime
  endAt   DateTime?

  status          SessionStatus @default(SCHEDULED)
  autoRecommended Boolean       @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, startAt])
  @@map("scheduled_sessions")
}

model DailyRecommendation {
  id String @id @default(uuid()) @db.Uuid

  clientId String        @db.Uuid
  client   ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  date      DateTime // only the date part is relevant
  focusText String // "Focus of the day"
  tipsText  String? // 1–2 tips concatenated into one string

  hasWorkoutToday Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, date])
  @@index([date])
  @@map("daily_recommendations")
}

model DailyCheckin {
  id String @id @default(uuid()) @db.Uuid

  clientId String        @db.Uuid
  client   ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  date           DateTime
  nutritionScore Int // slider 0–10
  painAtTraining Boolean
  note           String?

  createdAt DateTime @default(now())

  @@unique([clientId, date])
  @@index([date])
  @@map("daily_checkins")
}

model NutritionGoal {
  id String @id @default(uuid()) @db.Uuid

  clientId String        @db.Uuid
  client   ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  weekStartDate       DateTime
  proteinTargetPerDay Int
  waterTargetMlPerDay Int
  weeklyFocus         String // phrase shown in the "You" tab

  createdAt DateTime @default(now())

  @@index([clientId, weekStartDate])
  @@map("nutrition_goals")
}

model InviteCode {
  id   String @id @default(uuid()) @db.Uuid
  code String @unique // "TRAIN-ABC123"

  trainerId String  @db.Uuid
  trainer   AppUser @relation("TrainerInvites", fields: [trainerId], references: [id], onDelete: Cascade)

  // Optional pre-fill data
  clientEmail     String?
  clientFirstName String?
  clientLastName  String?

  // Status
  used         Boolean   @default(false)
  usedByUserId String?   @unique @db.Uuid
  usedBy       AppUser?  @relation("UsedInvite", fields: [usedByUserId], references: [id])
  usedAt       DateTime?

  expiresAt DateTime?
  createdAt DateTime  @default(now())

  @@index([trainerId])
  @@index([code])
  @@map("invite_codes")
}

// ============================================
// WORKOUT PROGRAMS
// ============================================

model WorkoutProgram {
  id              String  @id @default(uuid()) @db.Uuid

  // NULL = program default (seed), altfel = program custom trainer
  trainerId       String? @db.Uuid
  trainer         AppUser? @relation("TrainerPrograms", fields: [trainerId], references: [id], onDelete: Cascade)

  name            String
  description     String?
  sessionsPerWeek Int
  durationWeeks   Int?

  isDefault       Boolean @default(false) // true pentru programe seed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions        ProgramSession[]
  clientPrograms  ClientProgram[]
  recommendedIn   ProgramRecommendationLog[] @relation("RecommendedProgram")
  selectedIn      ProgramRecommendationLog[] @relation("SelectedProgram")

  @@index([trainerId])
  @@index([isDefault])
  @@map("workout_programs")
}

model ProgramSession {
  id         String @id @default(uuid()) @db.Uuid
  programId  String @db.Uuid
  program    WorkoutProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  dayNumber  Int    // 1, 2, 3, 4
  name       String // "Upper Body A"
  focus      String // "UPPER", "LOWER", "FULL_BODY", "PUSH", "PULL", "LEGS"
  notes      String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessionExercises SessionExercise[]

  @@index([programId])
  @@map("program_sessions")
}

model ClientProgram {
  id              String @id @default(uuid()) @db.Uuid
  clientId        String @unique @db.Uuid // un client are doar 1 program activ
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  programId       String @db.Uuid
  program         WorkoutProgram @relation(fields: [programId], references: [id])

  startDate       DateTime
  endDate         DateTime?
  active          Boolean @default(true)

  // Zilele săptămânii când se antrenează
  trainingDays    Json // ["MONDAY", "WEDNESDAY", "FRIDAY", "SATURDAY"]

  // Dacă e personalizat pentru acest client (clonare)
  isCustomized    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([programId])
  @@map("client_programs")
}

model ProgramRecommendationLog {
  id        String @id @default(uuid()) @db.Uuid
  clientId  String @db.Uuid
  client    ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Recommendation details
  recommendedProgramId String @db.Uuid
  recommendedProgram   WorkoutProgram @relation("RecommendedProgram", fields: [recommendedProgramId], references: [id])

  score               Float
  confidence          String // HIGH, MEDIUM, LOW
  reasons             Json   // array of reasons
  warnings            Json?  // array of warnings

  // Context at time of recommendation
  clientStats         Json   // completion rate, consistency, etc.

  // Trainer action
  trainerAccepted     Boolean?
  trainerSelectedProgramId String? @db.Uuid
  trainerSelectedProgram   WorkoutProgram? @relation("SelectedProgram", fields: [trainerSelectedProgramId], references: [id])
  trainerFeedback     String? @db.Text
  actionTakenAt       DateTime?

  createdAt DateTime @default(now())

  @@index([clientId, createdAt])
  @@map("program_recommendation_logs")
}

// ============================================
// EXERCISES
// ============================================

model Exercise {
  id          String @id @default(uuid()) @db.Uuid

  name        String // "Bodyweight Squat"
  description String @db.Text
  howTo       Json   // array of strings - pașii cum se execută
  cues        Json   // array of strings - indicații tehnice
  mistakes    Json   // array of strings - greșeli comune

  category    ExerciseCategory
  equipment   Json              // array: ["BODYWEIGHT", "DUMBBELL", "BARBELL"]
  difficulty  ExerciseDifficulty

  // NULL = exercițiu default (seed), altfel = exercițiu custom trainer
  isDefault   Boolean  @default(false)
  trainerId   String?  @db.Uuid
  trainer     AppUser? @relation("TrainerExercises", fields: [trainerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessionExercises SessionExercise[]

  @@index([category, difficulty])
  @@index([trainerId])
  @@index([isDefault])
  @@map("exercises")
}

model SessionExercise {
  id        String @id @default(uuid()) @db.Uuid

  sessionId String @db.Uuid
  session   ProgramSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  exerciseId String @db.Uuid
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  // Detalii despre cum se face exercițiul în această sesiune specifică
  orderInSession Int     // ordinea în care apare în sesiune (1, 2, 3...)
  sets           Int     // 3 seturi
  reps           String? // "8-12" sau "10" sau "AMRAP" sau "30 sec"
  restSeconds    Int?    // 60 secunde pauză între serii
  tempo          String? // "3-1-1-0" (eccentric-pauză-concentric-pauză)
  notes          String? @db.Text // "Focus on form" sau alte indicații specifice

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, exerciseId, orderInSession])
  @@index([sessionId])
  @@index([exerciseId])
  @@map("session_exercises")
}
